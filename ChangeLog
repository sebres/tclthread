2002-04-27  Zoran Vasiljevic <zoran@archiware.com>  

	* generic/threadCmd.c: fixed processing of -eventmark. We now
	properly wait for target thread to catch up with processing events.

2002-04-07  Zoran Vasiljevic <zoran@archiware.com>  

	* generic/threadCmd.c: added call to Ns_TclMarkForDelete(interp)
	when compiled for AOLserver support, otherwise we were leaking std
	channels on thread exit.

2002-04-03  Jeff Hobbs  <jeffh@ActiveState.com>

	* Makefile.in: improved use of DESTDIR in install targets.
	Removed need for installdirs target.
	Broke TCLSH_PROG into TCLSH_ENV and TCLSH_PROG with TCLSH var and
	added comments about TCLSH_ENV.
	Added default shell and gdb targets.

	* configure: 
	* configure.in: updated to new TEA base that: prefixes all macros
	with TEA_* instead of SC_*; adds TEA_PREFIX, which defaults the
	prefix and exec_prefix values to what Tcl used; adds
	TEA_SETUP_COMPILER, which handles basic compiler / support program
	checks and simplifies the configure.in.  Turn on --enable-threads
	by default and do sanity checking as well.

2002-04-01  Jeff Hobbs  <jeffh@ActiveState.com>

	* Makefile.in (install-lib-binaries): ensure that binary files are
	installed with executable bit set (use INSTALL_PROGRAM)

2002-03-28  Jeff Hobbs  <jeffh@ActiveState.com>

	* configure:
	* configure.in: BUILD_${PACKAGE} had to be static BUILD_thread in
	AC_DEFINE because autoconf wasn't substituting ${PACKAGE}.

2002-03-27  Jeff Hobbs  <jeffh@ActiveState.com>

	* Makefile.in (TCLSH_PROG): moved and updated env var definitions
	to have tclsh work from build dir.  Removed TCL_EXTRA_CFLAGS,
	TCL_LD_FLAGS, TCL_SHLIB_LD_LIBS, TCL_DBGX, TCL_STUB_LIB_FILE,
	TCL_STUB_LIB_SPEC as they aren't needed (configure acquires all
	that info for us).  TCL_LIBS is also not needed, but left in as a
	reference to the libs Tcl used.

	* configure: regen based on updated tclconfig/tcl.m4
	* configure.in: moved the SHLIB_LD_LIBS magic into
	tclconfig/tcl.m4 and noted where users can modify (SHLIB_LD_)LIBS.

2002-03-19  Jeff Hobbs  <jeffh@ActiveState.com>

	* generic/tclThread.h: 
	* generic/threadCmd.c: added stub voodoo magic to allow building
	against Tcl 8.3 and still get all the 8.4+ functionality when later
	loaded into an 8.4+ interp.

	* pkgIndex.tcl.in: simplified auto-generated pkgIndex.tcl file.

	* tests/all.tcl:
	* tests/thread.test: improved to detect 8.3/8.4 pkg differences

	* tclconfig/tcl.m4,install-sh (new):
	* config/* (removed):
	* aclocal.m4: 
	* configure: 
	* configure.in: 
	* Makefile.in: Updated build system to use tclconfig (TEA 2002)
	structure.

2002-03-09  Zoran Vasiljevic <zoran@archiware.com>

	* generic/threadSvCmd.c: fixed memory leak when copying objects
	using custom object duplicator. If a duplicator was registered
	more than once, we were leaking memory.

2002-03-08  Zoran Vasiljevic <zoran@archiware.com>

	* generic/threadCmd.c: added thread::configure -unwindonerror
	configuration option. See docs for usage.
	
	* doc/thread.n: added docs for thread::configure -unwindonerror
	
2002-03-07  Zoran Vasiljevic <zoran@archiware.com>

	* generic/threadSvCmd.c: tsv::names will skip reporting shared
	arrays with leading dot in their names. This is turned-on 
	only for AOLserver builds with the HIDE_DOTNAMES. For the
	regular Tcl builds, all arrays are reported, regardless of
	the name. Motivation behind this feature is to allow certain
	data privacy. It is not name-clash proof, though.

2002-02-12  Zoran Vasiljevic <zoran@archiware.com>

	* generic/threadCmd.c: fixed thread::preserve glitch. We never
	actually did bump the reservation counter by a silly mistake.

2002-02-12  Zoran Vasiljevic <zoran@archiware.com>

	* generic/threadCmd.c: added thread::preserve and thread::release
	commands. These allow for a simple reference counting when creating
	and/or tearing-down threads. Instead of calling thread::unwind in
	the target thread, one can use "thread::release id" to dispose it.
	This is much easier to use and it can be coupled with calls to
	thread::preserve to implement simple thread reservation mechanism.

	* doc/thread.n: added docs for thread::preserve/thread::release
	
2002-02-09  Zoran Vasiljevic <zoran@archiware.com>

	* generic/threadCmd.c: added thread::configure interface.
	Currently only "-eventmark" option is supported.
	Allows for AOLserver builds to change the "thread::" prefix
	by re-defining the "NS" compile-time constant.

	* doc/thread.n: added docs for thread::configure

2002-02-06  Zoran Vasiljevic <zoran@archiware.com>

	* generic/aolserv.cpp: (new) added for loading into the AOLserver.
	Still needs to fix the Makefile and friends to get it up and
	running.

	* generic/threadCmd.c: added conditional setup of the command
 	prefix. Now, the "NS" can be used to select the command prefix
 	for thread::* commands.

2002-01-26  David Gravereaux <davygrvy@pobox.com>

	* generic/threadSvCmd.c:  A small 'const' qualifier change to remove a
	warning.  It's a bit more wordy now, but reads a little clearer to me.
	Unscambling pointer math gives me a headache and combined with a cast
	tends to get dangerous.

	* win/threadWin.c: new idea for thread::kill added.  It's wrapped in an
	#if 0/#endif for now.  I do notice that tcl.h is now typedef'ing
	ClientData as an 'int *'.  It used to 'void *', didn't it??  The
	ISO/ANSI/CLEAN C style of setting a typed pointer to a void* now doesn't
	want to work.  Maybe I do too much C++ to have noticed this before...

2002-01-23  Zoran Vasiljevic <zoran@archiware.com>

	* generic/threadCmd.c: fixed address of the target interpreter when
	doing the callback async script processing. All messages went to the
	main interpreter instead of the selected interpreter, causing process
	to hung when posting callbacks to more that one interp at the same time.
	(thanks Jean-Luc Fontaine for the tip)

2002-01-20  Zoran Vasiljevic <zoran@archiware.com>

	* generic/threadCmd.c: fixed multiple async reporting of error events
	(thanks Jean-Luc Fontaine for the tip)
   
2002-01-02  Zoran Vasiljevic <zoran@archiware.com>

        * generic/threadSvListCmd.* (new): added for the new implementation
        of the thread-shared-variable (tsv) interface.
        * generic/threadSvCmd.c: now uses shared Tcl objects instead of strings
        for storing data in shared arrays. This improves performance on large
        shared data structures.
        Added new tsv::* syntax, per request. This replaces older thread::sv_*
        interface. Older commands are still present but will be removed as
        soon we hit the 3.0 version.
        * generic/threadCmd.c: revamped to support asynchronous backfiring
        of scripts so we can vwait on the results of thread processing.
        This also corrected the bug #464340. Affected command is thread::send.
        * doc/thread.n: added docs for all thread::* and tsv::* commands.
        This fixes #416850 bug report. The html/tmml files are still out of date.
        * configure: built with autoconf 2.52
        * config/config.guess (new): needed for the new configure
        * config/config.sub (new): needed for the new configure
        * Makefile.in: added lines for new generic/threadSvListCmd.c
        * configure.in: moving to 2.4 version.
        * unix/threadUnix.c: removed traces of ThreadKill. It is still not clear
        wether we should implement this functionality or not.
        * win/threadWin.c: see above.
        * pkgIndex.tcl.in: fixed to correctly handle version for different Tcl core
        versions.

2001-09-05  David Gravereaux <davygrvy@pobox.com>

	* generic/*:
	* win/threadWin.c (new): updated for a new threadWin.c and finished
	replacing use of thread.h with tclThread.h.  threadWin.c is an
	experiment to add a 'thread::kill' command.  Not done yet.

	* win/vc/thread.rc (removed):
	* win/thread.rc (new): moved it up a directory.

2001-09-04  David Gravereaux <davygrvy@pobox.com>

	* generic/thread.h (deleted):
	* generic/tclThread.h (new):
	* generic/threadCmd.c:  decided to change the name of 'thread.h' to
	'tclThread.h', per request.

	* generic/thread.h:
	* generic/threadCmd.c:  Re-added original implimentation of [thread::exit].
	for `emergency use only`.  You have been warned ;)

	* configure.in:
	* configure:
	* win/vc/thread.dsp:
	* win/vc/pkg.vc:  Upped version numbers to 2.3 and 2.1.3 because I just cut
	a release.

2001-09-04  David Gravereaux <davygrvy@pobox.com>

	-=[ Official 2.2 Tagged and cut. ]=-

2001-05-27  David Gravereaux <davygrvy@pobox.com>

	* tests/thread.test: fixed small typo in comments.

2001-08-03  Jeff Hobbs  <jeffh@ActiveState.com>

	* Makefile.in: corrected handling of VERSION

	* generic/threadCmd.c:
	* generic/thread.h: added Thread_SafeInit

	* win/vc/makefile.vc: added -DBUILD_thread to cflags.

2001-05-27  David Gravereaux <davygrvy@pobox.com>

	* configure:
	* configure.in:
	* Makefile.in:
		Added package versions to the compile flags. [bug #421246]

2001-04-28  David Gravereaux <davygrvy@pobox.com>

	* generic/threadCmd.c (NewThread): removed the previous addition of
	Tcl_FinalizeThread.  Tcl_ExitThread calls it anyways (my mistake).
	The resource leak was in the core.  See ->
	http://sourceforge.net/tracker/?func=detail&atid=110894&aid=419683&group_id=10894
	for the fix.  That patch is pending approval.

	To acheive the same behavior of emptying the event loop the way
	thread::wait used to work, use the following:
		set T [thread::create {thread::wait; update}]
		thread::send -async $T thread::unwind

	* generic/thread.h:
	* win/vc/makefile.vc:
	* win/vc/thread.rc:
	* win/vc/pkg.vc (new): Moved version numbers from the header file.  It isn't
	an export API or anything.  Moved version numbers to the build files.  I'll
	modify configure.in and makefile.in a little later.

2001-04-26  David Gravereaux <davygrvy@pobox.com>

	* config/* (new): old site-wide config directory re-added.

	* generic/threadCmd.c (ThreadEventProc): ThreadErrorProc now
	supported in asyncronous sends when Tcl_Eval returns other than
	TCL_OK.  Errors were silently ignored prior to this. Bug #219324

	==== INTERFACE CHANGE ====
	* generic/threadCmd.c:
	* generic/thread.h: thread::exit renamed to thread::unwind. The
	name of 'exit' is misleading.  An exit implies an unconditional
	return.  But there are conditions.  'unwind' describes with more
	clarity what's happening to the prior thread::wait.  For example:

	  # parent thread
	  set T [thread::create {source worker.tcl}]
	  ....
	  thread::send -async $T doStuff
	  ....
	  thread::send -async $T doStuff
	  ....
	  thread::send -async $T thread::unwind

	  # worker.tcl
	  proc init    {} {#do initialization}
	  proc cleanup {} {#do cleanup}
	  proc doStuff {} {#the work}
	  init
	  thread::wait
	  cleanup

	When worker.tcl is sourced, the execution stops at thread::wait and
	the event loop is entered.  When thread::unwind is sent to the worker,
	thread::wait falls-out and cleanup is called.  The condition for
	thread::unwind to cause an exit is determined by the script.  If
	thread::wait was the last Tcl command in the script, yes the thread
	will exit.  But if thread::wait is not the last, the execution of the
	script is just continued.  Hence, the name change to clarify this fact.

	Package version has not been changed.  There hasn't been an official
	release of 2.2, so it stays.

	* doc/thread.n:
	* tests/thread.test: Replaced thread::exit with thread::unwind and
	documented the change and clarified the subtleties.

	* win/vc/makefile.vc:
	* win/vc/thread.dsp: Changed NODEBUG macro to be DEBUG instead.
	Double negatives give me a headache.  DEBUG=1 makes more sense
	to me than NODEBUG=0.  Not that I didn't think you wouldn't have
	disagreed it was confusing, no?

	* win/vc/config.vc: Added a reminder to edit before using.
	* win/vc/thread.rc: Added authors and removed the Ajuba branding.

2001-04-25  David Gravereaux <davygrvy@pobox.com>

	* generic/threadCmd.c (ThreadWait)(NewThread): Removed the event
	loop sinking which was probably done because Tcl_FinalizeThread
	was missing from NewThread().  Now the event loop is cleaned
	by Tcl_FinalizeThread and ThreadWait doesn't manipulate events
	that don't belong to it.  Bug #418689 and #418693

	* generic/threadCmd.c (Thread_Init): logic fix in a version check
	for determining the 8.3 package subset.

2000-11-02  David Gravereaux <davygrvy@ajubasolutions.com>

	* generic/threadCmd.c (NewThread): Added logic to test for a
	working Tcl_Init() based on the core version at runtime and ignore
	its failure in versions 8.3.[1,2] and 8.4a1.  [BUG: 5301]

2000-10-26  David Gravereaux <davygrvy@ajubasolutions.com>

	* generic/thread.h:
	* win/vc/config.vc:
	* win/vc/makefile.vc:
	* win/vc/thread.dsp: upped version numbers to 2.2 along with adding
	a new macro (THREAD_VERSION_SUBSET83) defining the version when
	loaded into an 8.3 core.  Which happens to be "2.1.1" at this time.

	* generic/threadCmd.c (Thread_Init): Added logic to allow setting
	the package version at runtime to "2.2" when compiled against 8.4
	and loaded into 8.4.  When compiled against 8.4, yet loaded into
	8.3, thread::join and thread::transfer are not added to the interp
	and the package version is set to "2.1.1" instead from the single
	binary.  [ie. multiple interfaces in one binary]  When compiled
	against 8.3, thread::join and thread::transfer are non-existant and
	the package version is always "2.1.1" to maintain a consistent
	interface in all combinations (as per discussions with Don Porter).

2000-10-16  Zoran Vasiljevic <zoran@munich.com>

	* generic/threadSvCmd.c ThreadSvUnsetObjCmd(): deadlocked.
        Forgot to release shared-array lock which resulted in
        deadlock after first successful unset of the variable.

2000-08-29  David Gravereaux <davygrvy@ajubasolutions.com>

	* generic/threadCmd.c (NewThread): Tcl_Init return value wasn't
	being verified.  Added a check and failure logic to fall-out.
	[Bug: 5301]

2000-08-28  David Gravereaux <davygrvy@ajubasolutions.com>

	* generic/threadCmds.c (Thread_Init): Added logic to enable
	thread::join and thread::transfer when loaded into an 8.4+ core.
	We don't want a seg fault when the Stubs tables don't match for
	the functions that don't exist in an 8.3 core.

2000-08-23  Brent Welch <welch@ajubasolutions.com>

	* configure.in:
	* win/vc/makefile.vc: Changed to version 2.1
	* generic/threadCmds.c: Made the code that uses new Tcl 8.4 APIs
	conditional using #ifdef.  Tested with 8.3.2
	* Applied thread-2-1 tag for use with tclhttpd bundled release.

2000-08-21  David Gravereaux <davygrvy@ajubasolutions.com>

	* win/vc/makefile.vc:
	* win/vc/thread.rc: added version numbers to filename to follow
	Tcl standards.

	* doc/thread.tmml(new): Initial TMML document.

2000-08-20  David Gravereaux <davygrvy@ajubasolutions.com>

	* win/vc/config.vc:
	* win/vc/makefile.vc:
	* win/vc/README.txt:
	* win/vc/thread.dsp:  A near top down rewrite that adds
	four more build configurations.  See README.TXT for the
	details.

	* win/vc/.cvsignore:  A few more glob patterns added to match
	the new build directories.

2000-08-09  David Gravereaux <davygrvy@ajubasolutions.com>

	* win/vc/thread.rc: swapped "Scriptics Corp" for "Ajuba
	Solutions"

	* win/vc/config.vc:
	* win/vc/makefile.vc: cleaned-up old cruft.  Added new files
	from Zoran's patches.  made swapping to MSDev 6.0 easier.
	Removed the '!if $(_NMAKE_VER) > 162' test for 2 reasons.

	1) batchmode inference rules are valid since MSDev 5.0 and
	the core can't be built with less.  So don't bother testing.

	2) nmake.exe that comes with MSDev 6.0 has a bug with the
	meaning of that macro and MS decided to use a string instead
	breaking the integer comparison test.

	Also added vcvars32.bat to a new setup rule and got config.vc
	much smaller.

	* win/vc/thread.dsp: Added new files from Zoran's patch.

	* win/.cvsignore(deleted):
	* win/vc/.cvsignore(added): moved file to help keep a cleaner
	build environment.

	* generic/threadSvCmd.c: Added some additional casting of
	Tcl_GetHashValue to prevent compiler warnings.

	* generic/threadCmd.c(ThreadWait): Removed the event loop
	sinking after the "while(..) Tcl_DoOneEvent();" because this
	extension is only responsible for it's own events in the event
	loop.  Any other extension that's queueing events must be
	responsible for it's own cleanup and should be aware of when
	the interp (ie. this thread) is going away when we fall-out
	to Tcl_DeleteInterp from the Tcl_Eval in NewThread().  If other
	extensions (like Tk) don't become aware, then they need to add
	a Tcl_CallWhenDeleted handler.

2000-07-14 Zoran Vasiljevic <zoran@munich.com>

	* generic/threadCmd.c: improved thread::exit behaviour
	  now does a better job of draining the event loop before exit.
	  may have some wishes open, though - see ThreadWait().
	
	* generic/threadSpCmd.c, generic/threadSvCmd.c:
	  added some comments in function headers.
	  docs/tests for above still pending.
	
2000-07-03 Zoran Vasiljevic <zoran@munich.com>
	
   	Summary of changes:

	* generic/threadSpCmd.c: new file with implementation of 
	  "thread::mutex" and "thread::cond" commands. Documentation 
	  and tests are still pending.
	
	* generic/threadSvCmd.c: new file with implementation of 
	  "thread::sv_*" family of commands modeled after AOLserver
	  nsv_* ones. Documentation and tests are still pending.

	* Makefile.in: fixed for the two above

	* doc/thread.html 
	* doc/thread.n: added 'thread::exists' docs

	* generic/thread.h added declarations for new commands (above)
	
	* generic/threadCmd.c:
	
	  Added "thread::exists" command.

	  Moved most of internal functions in threadCmd.c to statics,
          except the Thread*ObjCmd(). 

	  Changed behaviour of "thread::exit". It now simply flips the
          bit to signal thread stuck in thread::wait to gracefuly exit.
          Consequence: command now does not trigger error on thread exit.
          Also, thread event queue is now properly cleared.
          ThreadWait() and ThreadStop() are newly added to support this.
          Also the ThreadSpecificData has one more integer: "stopped"

	  Replaced ref's to obsolete Tcl_GlobalEval() with Tcl_EvalEx().

	  Fixed broken 'thread::create -joinable script';
          was missing initialization of script variable

	  Added calls to initialize new commands in threadSpCmd.c
	  and threadSvCmd.c files.

2000-05-18 Brent Welch <welch@scriptics.com>

	* Restored Andreas' changes for transferring sockets.

2000-05-16 Brent Welch <welch@scriptics.com>

	* Temprarily rolled back Andreas' changes so I can fix up
	the 2.0 release (configure and Make).  Also need to apply
	a 2.0 tag.

2000-05-09 Andreas Kupries  <a.kupries@westend.com>

	* tests/thread.test: Removed dependency on aclocals.m4. Using a
	  real temporary file now, as created by a call to
	  tcltest::makeFile. Updated test 6.3 to use the correct length
	  information.

2000-05-04  Andreas Kupries <a.kupries@westend.com>

	* Overall changes:
	  (1) Added joinable threads.
	  (2) Added transfer of channels between threads.

	* generic/threadCmd.c: Added functions Thread_Join and
	  ThreadJoinObjCmd.

	  Extended function ThreadCreateObjCmd to handle a
	  -joinable flag.

	  Fixed bug in Thread_Create, the argument 'stacksize' was not
	  used.

	  Removed declaration of ThreadObjCmd, which was not used anywhere
	  else in the code.

	  Added functions Thread_Transfer, ThreadTransferEventProc and
	  ThreadTransferObjCmd. Extended behaviour of ThreadDeleteEvent
	  and ThreadExitProc to deal with the new class of events.

	  Changed usage of ckfree to the more canonical Tcl_Free. Same for
	  ckalloc and Tcl_Alloc.

	* Makefile.in: Fixed bug with regard to the installation of
	  documentation.

	* doc/thread.*: Added documentation of create -joinable,
	  thread::join and thread::transfer.

	* tests/thread.test: Added tests for joining of threads and moving
	  channels between threads.

2000-04-19  Brent Welch <welch@scriptics.com>

	* win/vc/config.rc, Makefile.vc: Fixes from David Gravereaux

2000-04-18  Brent Welch <welch@scriptics.com>

	* Makefile.in: Fixes for make install

2000-04-17  Brent Welch <welch@scriptics.com>

	* generic/threadCmd.c
	Added Tcl_CreateThreadType and TCL_RETURN_THREAD_TYPE
	macros for declaring the NewThread callback proc.

2000-04-11  Brent Welch <welch@scriptics.com>

	* Picked up minor changes from David Gravereaux <davygrvy@bigfoot.com>
	* for compilation on windows with his alternate project files.

2000-04-10  Brent Welch <welch@scriptics.com>

	* Moved all the configure.in, Makefile.in etc. up to the top level out
	* of the unix (and win) subdirectories.  These are now shared.
	* If you are using CVS, you'll want to get the "config" module into
	* this directory, or do the checkout of thread again so the config
	* module is brought in.  You should have a "config" subdirectory of
	* your main thread workspace directory.

2000-04-09  Brent Welch <welch@scriptics.com>

	* Updated to compile against 8.3.1 export thread APIs
	* Added Windows makefiles

2000-03-27  Brent Welch <welch@scriptics.com> (proxy for Andreas Kupries)

	* tests/all.tcl: Added this file
	* tests/thread.test: fixed to use tcltest
	* doc/thread.n: Added this file as clone of thread.html
	# doc/thread.html: fixed typo

